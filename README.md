# README
山の景色の写真を投稿できるサイトです。  
訪れた山で撮った写真を位置情報とメッセージを含めて投稿し、皆で共有することができます。  
地図を辿りながら景色を眺めることで登山を追体験できるサイトを目指して作製しました。


## URL

## 利用方法
ゲスト用アカウントでログインすることで新規登録をスキップし、一連の利用方法を体験することができます。  
(注) ゲスト用アカウントでログインした場合、アカウント設定の編集及びアカウント削除は実行できません。
* ゲスト用アカウント
<table>
  <tr>
    <td>ニックネーム</td>
    <td><strong>Guest</strong></td>
  </tr>
  <tr>
    <td>メールアドレス</td>
    <td><strong>guest@example.com</strong></td>
  </tr>
  <tr>
    <td>パスワード</td>
    <td><strong>password</strong></td>
  </tr>
</table>

  #### 新規登録
  ヘッダーもしくはルートページの "新規登録" ボタンから新規登録ページへ移動します。ニックネーム(30文字以内)、メールアドレス、パスワード(半角英数6文字以上)を入力し、"アカウントを作成する" ボタンをクリックするとアカウントが作成され、ロクイン状態となってマイページへ移動します。

  #### ログイン・ログアウト
  ヘッダーもしくはルートページの "ログイン" ボタンからログインページへ移動します。登録したアカウントのメールアドレス、パスワードを入力し、"ログインする" ボタンをクリックするとログインすることができます。また、ログインページのチェックボックス "ログイン状態を保持する" にチェックを入れてログインすると、ブラウザを閉じてもログイン状態が保持されます。
  ログインすると、投稿機能といいね!機能(お気に入り登録)が使用できます。
  ログアウトするには、ヘッダーのアイコンメニューまたはマイページのサイドメニューにある "ログアウト" 選択します。

  #### アカウント設定
  ログイン状態でヘッダーのアイコンメニューまたはマイページのサイドメニューにある "プロフィール" を選択すると、現在のアカウント設定(アバター画像、ニックネーム、メールアドレス、紹介文)を確認することができます。他ユーザーに対してはプロフィールとしてアバター画像、ニックネーム、紹介文が公開されます。メールアドレスは公開されません。  
  アカウント設定を変更したい場合は、ヘッダーのアイコンメニューまたはマイページのサイドメニューにある "アカウント設定" を選択します。アバター画像(.jpg/.jpeg/.png/.gif)、ニックネーム、メールアドレス、パスワード、紹介文のうち、変更したい項目についてフォームに入力し、"変更を保存する" ボタンをクリックすると変更が反映されます。

  #### 山を検索
  ヘッダーの "山を探す" ドロップダウンリストのいずれかもしくはルートページの "山を探す" ボタンをクリックすると検索ページへ移動します。タブを切り替えることで、4つの方法(山名から探す、都道府県から探す、山域から探す、タグから探す)で山を検索することができます。  
  山名から探す場合、検索フォームに文字(漢字または平仮名)を入力して "検索" ボタンをクリックすると、山名にその文字が含まれる山が一覧表示されます。文字の間にスペースを入れることでAND検索も可能です。

  #### 投稿の閲覧
  検索結果の山を選択すると個別のページに移動します。地図上の<font color="Red">*赤いピン*</font>が写真撮影地点を示しており、ピンをクリックするとその投稿の詳細(写真、投稿したユーザー名、メッセージ、投稿日、いいね!数)が表示されます。写真が複数ある場合は左右の矢印ボタンで表示の切り替えが可能です。また、"一覧から探す" タブをクリックすると、投稿を一覧で表示させることができ、並び順は新着順またはいいね!数の多い順の2パターンを切り替えることができます。  
  更に、投稿の詳細に表示される投稿したユーザー名をクリックすると、そのユーザーの個人ページへ移動し、プロフィールとユーザーの全ての投稿を閲覧することができます。

  #### 投稿する
  ログイン状態で投稿したい山の個別ページに移動します。"投稿する" タブを選択し、下記4つの手順で投稿することができます。尚、"投稿方法を確認" ボタンをクリックすることでいつでも投稿方法を確認することができます。
  1. __撮影地点を決める__  
    マップ上をクリックする、もしくは緯度・経度を入力して "マーカーを設置" ボタンをクリックすることでマップ上に<font color="Blue">*青いピン*</font>を設置します。投稿を完了するには青いピンの設置が必須となります。
  2. __メッセージを残す__  
    この投稿についてのメッセージを入力します。メッセージは空欄でも投稿することができます。
  3. __写真を追加する__  
    "写真を追加する" ボタンをクリックし、この投稿に追加したい画像ファイル(.jpg/.jpeg/.png/.gif)を選択します。選択した画像が表示されるので、取り消したい場合は画像の右上にある "×"ボタンをクリックします。1つの投稿につき追加できる画像は10枚までです。投稿を完了するには1枚以上の画像が必須となります。
  4. __投稿を完了する__  
    "この内容で投稿する" ボタンをクリックし、画面に "投稿しました。" と表示されれば投稿は完了です。

  #### 投稿の管理と編集  
  ログイン状態でヘッダーのアイコンメニューまたはマイページのサイドメニューにある "投稿一覧" を選択すると、自身のこれまでの投稿が投稿日の新しい順に一覧表示されます。それぞれの投稿をクリックすると投稿の詳細(写真、位置、メッセージ、投稿日、いいね!数)を確認することができます。  
  投稿のメッセージを変更したい場合は、投稿の詳細ページから "メッセージを編集" ボタンをクリックし、フォームに新しいメッセージを入力して "変更を保存する" ボタンをクリックします。  
  投稿を削除したい場合は、投稿の詳細ページから "投稿を削除" ボタンをクリックすると、本当に削除するかどうかの確認メッセージが表示されるので、"削除する" ボタンをクリックします。

  #### 投稿にいいね！(お気に入り登録)する  
  ログイン状態で他ユーザーの投稿詳細の表示中に "いいね!" ボタンをクリックすると、ボタンの表示が "いいね済み" に変化します。この状態は、自身が表示中の投稿を既にいいね!(お気に入り登録)していることを示しています。 再度ボタンをクリックすることでいいね!(お気に入り登録)を解除することができます。  
  いいね!(お気に入り登録)した投稿を確認するには、ログイン状態でヘッダーのアイコンメニューまたはマイページのサイドメニューにある "お気に入り" を選択します。いいね!(お気に入り登録)した投稿が投稿日の新しい順に一覧表示されるので、それぞれの投稿をクリックすることでその投稿の詳細(写真、位置、投稿したユーザー名、メッセージ、投稿日、いいね!数)を確認することができます。

  #### アカウントの削除  
  ログイン状態でヘッダーのアイコンメニューまたはマイページのサイドメニューにある "アカウント設定" を選択します。"アカウントを削除する" ボタンクリックすると、本当に削除するかどうかの確認メッセージが表示されるので、フォームにアカウントのメールアドレスを入力して、"削除する" ボタンをクリックするとアカウントが削除されます。アカウントの削除と共にユーザーの投稿とお気に入り登録も削除されますのでご注意ください。


## 使用技術
- バックエンド
  - Ruby 3.0.3
  - Ruby on Rails 6.1.4.6
  - MySQL 8.0
  - RSpec 3.11
  - RuboCop 0.93.1
- フロントエンド
  - HTML
  - CSS
  - JavaScript
  - React 17.0.2
  - Material UI v5
  - @react-google-maps/api 2.12.0
- 開発と運用
  - Docker / Docker Compose
  - Heroku
  - CircleCI
  - Amazon Web Service
  - git / GitHub

## データベース設計
作成したテーブルをER図として以下に示す。
![Blueprint of Database](/public/figures/blueprint-of-database.drawio.png)


## サーバー構成
アプリケーションを公開する為に Amazon Web Service (AWS) を利用した。以下にサーバー構成を示す。


## 開発フロー
以下に示す①〜⑦を繰り返すことで開発を進めた。
![Development Flow](/public/figures/development-flow.drawio.png)
① 新たに開発用ブランチを切ってローカル環境で開発  
② リモートリポジトリの開発用ブランチにpush  
③ pushをトリガーにCircle-CIのワークフローが開始される  
④ Lint/Formatのチェック、テスト、HEROKUへのデプロイが自動で実行される  
⑤ Heroku上(仮デプロイ)で問題がないことを確認  
⑥ プルリクエストを作成した後、mainブランチにmerge  
⑦ リモートリポジトリからローカルリポジトリへpull  


## 機能一覧
<table style="table-layout:fixed; width:100%">
  <tr>
    <th style="width:15%">機能</th>
    <th style="width:35%">目的</th>
    <th style="width:50%">詳細</th>
  </tr>
  <tr>
    <td>アカウント作成</td>
    <td style="font-size:90%">
      アカウント作成ユーザーにのみ各種機能(投稿または他ユーザーの投稿にいいね!)の実行権限を与える。
    </td>
    <td style="font-size:90%">
      Userテーブルにユーザーデータを追加することでアカウントを作成する。新規登録ボタンで表示されるフォームにニックネーム、メールアドレス、パスワードを入力することでアカウントを作成できる。Userモデル及びフロントエンド(React)の双方でバリデーションを設定することで各パラメータに無効な値を登録できないようにした。
    </td>
  </tr>
  <tr>
    <td>ログイン (通常)</td>
    <td style="font-size:90%">
      ユーザーがアカウントの本人かどうかを判別する。
    </td>
    <td style="font-size:90%">
      sessionメソッドを用いた通常ログイン機構。ログインボタンで表示されるフォームにメールアドレスとパスワードを入力することでログインできる。また、ログアウトボタンによりログアウトができる。
    </td>
  </tr>
  <tr>
    <td>ログイン (発展)</td>
    <td style="font-size:90%">
      ブラウザを閉じてもログイン状態を保持できるようにする。
    </td>
    <td style="font-size:90%">
      cookiesメソッドを用いた発展ログイン機構。ログイン時のチェックボックスにより通常ログインと発展ログインを切り替えることができる。
    </td>
  </tr>
  <tr>
    <td>フレンドリーフォワーディング </td>
    <td style="font-size:90%">
      非ログインユーザーがログインを必要とするページ(アカウント設定ページなど)にアクセスした場合に、ログインページにリダイレクトさせてログインした後にユーザーが開こうとしていたページにリダイレクトさせる。
    </td>
    <td style="font-size:90%">
      sessionメソッドを用いてリクエストURLを一時保存し、ログイン後にリクエストURLにリダイレクトさせるようにした。
    </td>
  </tr>
  <tr>
    <td>アカウント編集</td>
    <td style="font-size:90%">
      ユーザーが自身のアカウント情報を編集できるようにする。
    </td>
    <td style="font-size:90%">
      アカウント設定画面から各種パラメータ(アバター画像、ニックネーム、メールアドレス、パスワード、紹介文)を変更できる。before_actionを設定することで、非ログインユーザー及び他ユーザーのアカウント編集は実行できないようにした。
    </td>
  </tr>
  <tr>
    <td>パスワード再設定</td>
    <td style="font-size:90%">
      パスワードを忘れてしまったユーザーがパスワードを再設定してログインできるようにする。
    </td>
    <td style="font-size:90%">
      パスワード再設定用トークンとそれに対応するダイジェストを利用することでメールを介した安全なパスワード再設定とログインを可能にした。
    </td>
  </tr>
  <tr>
    <td>フリーワード検索</td>
    <td style="font-size:90%">
      フリーワードによる山名検索を可能にする。
    </td>
    <td style="font-size:90%">
      Mountainテーブルのname属性とyomi属性に対してwhereメソッドを用いた検索システム。検索フォームに文字入力することで検索結果が表示される。ワードの間にスペースを用いるAND検索に対応。
    </td>
  </tr>
  <tr>
    <td>ページネーション</td>
    <td style="font-size:90%">
      一つのページに表示する件数を制限し、スクロールを減らす。
    </td>
    <td style="font-size:90%">
      React Hooks (useState, useEffect) を用いたページネーション機能。表示アイテム数が多くなる可能性のある投稿一覧ページ、お気に入り一覧ページ、検索結果ページ等に設置した。
    </td>
  </tr>
  <tr>
    <td>投稿閲覧</td>
    <td style="font-size:90%">
      山の地図を辿りながらユーザーが投稿した写真を閲覧できるようにする。一目で人気のある投稿を探すことができる。
    </td>
    <td style="font-size:90%">
      Google Maps API を利用し、表示された Google Map 上のピンをクリックすることで投稿閲覧タブへのスムーズな移行と写真表示を可能にした。投稿一覧タブでは投稿日が新しい順といいね!数が多い順の2パターンを切り替え可能にし、投稿を一覧表示できるようにした。
    </td>
  </tr>
  <tr>
    <td>投稿</td>
    <td style="font-size:90%">
      ユーザーが撮影した写真を位置情報と共に公開できるようにする。自分の投稿を一覧表示して管理できるようにする。
    </td>
    <td style="font-size:90%">
      async/await を用いた非同期処理で実装した投稿機能。写真(10枚まで)と写真を撮った地点(地図をクリック or 緯度・経度入力)にメッセージを添えて投稿することができる。投稿は投稿閲覧ページとマイページの投稿一覧に表示される。
    </td>
  </tr>
  <tr>
    <td>いいね!</td>
    <td style="font-size:90%">
      気に入った他ユーザーによる投稿を一覧表示して管理できるようにする。いいね!された数を人気指標として表示する。
    </td>
    <td style="font-size:90%">
        async/await を用いた非同期処理で実装したお気に入り登録機能。ログインユーザーは他ユーザーの投稿のいいね!ボタンをクリックすることでお気に入り登録することができ、投稿のお気に入り登録数が非同期で表示される。お気に入り登録した投稿はマイページのお気に入り一覧に表示される。
    </td>
  </tr>
  <tr>
    <td>最新投稿フィード</td>
    <td style="font-size:90%">
      ユーザーに新しい投稿を知らせる。
    </td>
    <td style="font-size:90%">
      投稿日時が新しい順に3件の投稿がルートページに表示されるようにした。
    </td>
  </tr>
  <tr>
    <td>レスポンシブデザイン</td>
    <td style="font-size:90%">
      ユーザーが使用するデバイスの様々な画面サイズに応じて表示を最適化する。
    </td>
    <td style="font-size:90%">
      CSSメディアクエリの React Hook である useMediaQuery (from Material UI) を用いて全ページをレスポンシブデザイン化した。
    </td>
  </tr>
</table>


## 今後実装したい機能
- 登山ルートの表示
- 投稿へのコメント機能
